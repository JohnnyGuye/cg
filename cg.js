let joinDates = new Map();

Object.entries(
{"3799c30a7f390b64b9430ff53613309e489451":1374876000000,"6db919e4cba28b42e343a3f3d36d2768260153":1409608800000,"1724dffd64c8c26c9fa9a189691387b5760508":1421190000000,"356a959a96b807f8516f4f26e0bce4af9529261":1475280000000,"ffb5976de8bf8684701357ed253d4698019537":1419030000000,"8374201b6f1d19eb99d61c80351465b65150051":1469404800000,"e16f1e97c5a70becf16fa6a096e5f9459710041":1461110400000,"e9c83cc4767eb16667a33d90907479d08093402":1497225600000,"f30988de96c9c80005a6f5ec0986922f0411701":1443391200000,"40a6e8f95014d9402dd909b0f729290d384688":1428530400000,"f5f8fd68a484329ecd629d610c8d05755689841":1468022400000,"9afa6899fee419ca466331230cbf1aa2459533":1410818400000,"eced6d5a954e5fb4bcb48b3ec99387cf5364301":1441749600000,"2ba01b17814abb5180059ada26a17728306173":1411509600000,"de2c056486a7f4c8f72abb503e2493ec6134131":1456099200000,"64634007c01ea281188e005fba28899e6971021":1449705600000,"212ea5ea21e7f6499ed1873a203613c40399741":1467072000000,"b282f3812c90f2876848d5ce7829df0b847304":1411509600000,"771485904355a5f6267beb29429cad302257061":1474675200000,"30d5a991c36b67dde118002936eb22f80251431":1457049600000,"433c83b2f60d89f64e138f0fce10b30f8598731":1459641600000,"59c27936dbb3cdb9bfecd7e3456ecc5c825622":1393628400000,"4b43927547c991d2c5762a6315abaff4053738":1423609200000,"a44c2c75eb5da8d5e52184eaa92342813628822":1510185600000,"f6389a8319f07b08072b207feb2572c9790215":1413669600000,"5802d4b9aa9aa788d3a767777419afff0546011":1444860000000,"c14bcc11abf612c6372e5b12ae46a813580148":1423868400000,"67d8f07c840c2c6e411fd763bda615472617541":1464912000000,"b50b600f5dc25555f35bd2da9a0cf8a07356021":1450051200000,"0f52521a9b9fcf571dd3e47cb737fc6a4236002":1495238400000,"95c1888a89398ab8c1b3b8c8ff0e9237259458":1424818800000,"bb5285597a9c24c36f9666bc11bd512b9683331":1456790400000,"512fb043c43498b9bc7605da47190de72570011":1444600800000,"5314bd6220edf7561724c1e00140257a2839931":1461110400000,"175f7ed82ea69189ab84f4bb63d4495e9604911":1449187200000,"6cb3347803debcfe217e0c2ee03008588207231":1456444800000,"6a6c241b45275cc93528a35eaeffafb80325331":1456790400000,"61e8d089025dbb123cd4256f1c845c6a619891":1385161200000,"1c58aad756688f2e51646ad7af82b20e9518181":1486425600000,"bc23f1ca3f15d4ea8e766f8d3f65557a2421601":1443045600000,"dc5be2d951d61e3948cb537119c4c1ff596529":1432245600000,"f9a89e25b8ad8c2de4ec0e973eac6403383705":1413496800000,"9266aac326b0b7e51215b62cf308ea4c6901001":1439416800000,"102667d89432eb749ecf9120beb4f273487836":1417042800000,"73a5c7e75cde8949ee1fe332045d6d23163887":1420671600000,"2ab604db214dc812ff0be58a75280d0c947725":1414101600000,"64b12bb6680832931cbfc486f859a1f69663531":1457827200000,"30b3f989f1c90d3a2275e0f2e0583eec6721372":1531699200000,"4e36b25d9559dae2bae20b5db69784306424581":1487980800000,"8cfd1e8d7ec40e8dee09bd96fd4827e74830841":1467072000000,"1d87d0a239c8e2f69181240098e0bb515984292":1539820800000,"5ffdfe87b7fab8b9506047effaeaefd03358521":1453507200000,"96e62e1385aa7bcfd1c0449d1a7fbcc81456031":1455667200000,"8504ea93820b40cbbfa1b387dd4ea2065914522":1508889600000,"f4cfae1741fd16ece88704684714d7df8856061":1474675200000,"929804497a6f920dbf77ae19f4856424088133":1436392800000,"3f4adfba53d1ae216fb40f9c51b72c843953371":1480982400000,"256eb8b8d98ba74ad948a5d35b177af26974131":1456099200000,"820ffc01d7a8d3c31ed3a484436d73d43094601":1443132000000,"ae4dcda11ac0f4cc7369e049d99e90652587002":1495324800000,"b37ff95bf3d129f615a50e1524d5c944273628":1423090800000,"62318a760610d302620d798354f373b55014371":1480982400000,"d9b370618bb0e8b83b5462b388bc07cc1793761":1477353600000,"202191e57559de496f6693c2dc2b6735603238":1423436400000,"fb5182f1392c2ff1b516e438eba536c8297457":1419548400000,"5748080bdc5c200a1a70f8f64fe93326401494":1413237600000,"45184b23e68d79b7b6e386e6517992db751608":1421276400000,"e249d101c8838712e66ad3a52def518e4404661":1476835200000,"cbc8c34da7247faa3498ddfdaedd0339386351":1359500400000,"fa772c81b1fd7eb1c696251b0d04f7a65399401":1442527200000,"2f4716c2bd9376edbca00dd4b6c146765167611":1447977600000,"b49f2172bad5fed7111d13de7c8dc2752937841":1467763200000,"ead53cf9dd9808aee051326b776081d2353088":1427752800000,"523c6faa5b5fd827851bfedfd4632009624885":1415574000000,"44b6efeda4b71a74e1c48917383447b39557701":1443736800000,"89fa2a86513755e6ab1e3aa2274f0ebc836425":1414015200000,"ff0208f05f1260a9798ba68f92e61e89002923":1403906400000,"1d2d89304a3bbb4c205b841516bda13d2128811":1448928000000,"44ad7dfb96cc638e0241eb3581e4f25e1022422":1508371200000,"7f5096b63a434548e6c951bf1595cf6a6593581":1487894400000,"3f3fa4e79c0e740b05db1c82525f69ab5945141":1461974400000,"70fcac25aa6aa2fbd8b6cc955482d89c773751":1385161200000,"c972aa0f3001ab6929afac0ca002cc478892801":1444082400000,"ab9cc414371923a2e8eaef7466f874f1913517":1418598000000,"8f853a3f296bd38820f1a5be5346a12e2596571":1482364800000,"95bf46b5909e3e8a493f7dfa4fa8f6569949611":1448064000000,"b7338b10f30c35e6b38c5a0726582c25698551":1379714400000,"df4e9a1fb8d928f54db1f30a63dcfa511466142":1515974400000,"d28f5ffd900460f7cf40be3e267bbf14570637":1419030000000,"a858cb9483b31957524b33a65ae29846981812":1390604400000,"cde990b866fca7ad04f31e05026c8aad2394641":1465689600000,"bde077d117c0ede5979bb22d63c7c4896776341":1463011200000,"78aed65d7d2b7b2c5d0a90bff0bb0e2d1810601":1443045600000,"c469a2457993bc5c56f8b620b0e1b28f881651":1393628400000,"27b0208dd52b30b4e2b882e64a5be4691113431":1457136000000,"7cdf17716a256caf6f64a8e20b77ef277300471":1481241600000,"413a4b407176a4fa687687f3416a3057540351":1352242800000,"aefa30db4c16e84ff341b4f289deffc9157846":1417302000000,"b18c7ff15bc643397cbcfdc3db5feebf208539":1433455200000,"687d536b4e342533566e83cd9b5a799d2084851":1474329600000}
).forEach(entry => {
	const publicHandle = entry[0];
	const joinDate = entry[1];
	joinDates.set(publicHandle, joinDate);
});

function fetchRankings() {
	const xhr = new XMLHttpRequest();
	const reqURL = 'https://cors-anywhere.herokuapp.com/https://www.codingame.com/services/Leaderboards/getGlobalLeaderboard';
	xhr.open("POST", reqURL);
	xhr.responseType = "json";
	xhr.onreadystatechange = (e) => {
		if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
			const res = xhr.response;
			console.log(res);
			addJoinDates(0, res);
		}
	}
	xhr.send("[1,{'keyword':'','active':false,'column':'','filter':''},null,true,'global']");
}

function addJoinDates(player, leaderboard) {
	if (player === leaderboard.users.length) {
		console.log(JSON.stringify(mapToObject(joinDates)));
		updateRanking(leaderboard);
	} else {
		const publicHandle = leaderboard.users[player].codingamer.publicHandle;
		let joinDate = joinDates.get(publicHandle);
		if (joinDate) {
			leaderboard.users[player].joinDate = joinDate;
			addJoinDates(player + 1, leaderboard);
		} else {
			fetchJoinDate(player, publicHandle, leaderboard);
		}
	}
}

function mapToObject(map) {
	const out = Object.create(null)
	map.forEach((value, key) => {
		if (value instanceof Map) {
			out[key] = mapToObject(value)
		} else {
			out[key] = value
		}
	})
	return out
}

function fetchJoinDate(player, publicHandle, leaderboard) {
	const xhr = new XMLHttpRequest();
	const reqURL = 'https://cors-anywhere.herokuapp.com/https://www.codingame.com/services/CodinGamer/findCodingamePointsStatsByHandle';
	xhr.open("POST", reqURL);
	xhr.responseType = "json";
	xhr.onreadystatechange = (e) => {
		if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
			const res = xhr.response;
			console.log(res);
			const joinDate = res.codingamePointsRankingDto.rankHistorics.dates[0];
			joinDates.set(publicHandle, joinDate);
			leaderboard.users[player].joinDate = joinDate;
			addJoinDates(player + 1, leaderboard);
		}
	}
	xhr.send("['" + publicHandle + "']");
}

fetchRankings();
