let joinDates = new Map();

Object.entries(
{"3799c30a7f390b64b9430ff53613309e489451":1374876000000,"6db919e4cba28b42e343a3f3d36d2768260153":1409608800000,"1724dffd64c8c26c9fa9a189691387b5760508":1421190000000,"356a959a96b807f8516f4f26e0bce4af9529261":1475280000000,"ffb5976de8bf8684701357ed253d4698019537":1419030000000,"8374201b6f1d19eb99d61c80351465b65150051":1469404800000,"e16f1e97c5a70becf16fa6a096e5f9459710041":1461110400000,"e9c83cc4767eb16667a33d90907479d08093402":1497225600000,"f30988de96c9c80005a6f5ec0986922f0411701":1443391200000,"40a6e8f95014d9402dd909b0f729290d384688":1428530400000,"f5f8fd68a484329ecd629d610c8d05755689841":1468022400000,"9afa6899fee419ca466331230cbf1aa2459533":1410818400000,"eced6d5a954e5fb4bcb48b3ec99387cf5364301":1441749600000,"2ba01b17814abb5180059ada26a17728306173":1411509600000,"de2c056486a7f4c8f72abb503e2493ec6134131":1456099200000,"64634007c01ea281188e005fba28899e6971021":1449705600000,"212ea5ea21e7f6499ed1873a203613c40399741":1467072000000,"b282f3812c90f2876848d5ce7829df0b847304":1411509600000,"771485904355a5f6267beb29429cad302257061":1474675200000,"30d5a991c36b67dde118002936eb22f80251431":1457049600000,"433c83b2f60d89f64e138f0fce10b30f8598731":1459641600000,"59c27936dbb3cdb9bfecd7e3456ecc5c825622":1393628400000,"4b43927547c991d2c5762a6315abaff4053738":1423609200000,"a44c2c75eb5da8d5e52184eaa92342813628822":1510185600000,"f6389a8319f07b08072b207feb2572c9790215":1413669600000,"5802d4b9aa9aa788d3a767777419afff0546011":1444860000000,"c14bcc11abf612c6372e5b12ae46a813580148":1423868400000,"67d8f07c840c2c6e411fd763bda615472617541":1464912000000,"b50b600f5dc25555f35bd2da9a0cf8a07356021":1450051200000,"0f52521a9b9fcf571dd3e47cb737fc6a4236002":1495238400000,"95c1888a89398ab8c1b3b8c8ff0e9237259458":1424818800000,"bb5285597a9c24c36f9666bc11bd512b9683331":1456790400000,"512fb043c43498b9bc7605da47190de72570011":1444600800000,"5314bd6220edf7561724c1e00140257a2839931":1461110400000,"175f7ed82ea69189ab84f4bb63d4495e9604911":1449187200000,"6cb3347803debcfe217e0c2ee03008588207231":1456444800000,"6a6c241b45275cc93528a35eaeffafb80325331":1456790400000,"61e8d089025dbb123cd4256f1c845c6a619891":1385161200000,"1c58aad756688f2e51646ad7af82b20e9518181":1486425600000,"bc23f1ca3f15d4ea8e766f8d3f65557a2421601":1443045600000,"dc5be2d951d61e3948cb537119c4c1ff596529":1432245600000,"f9a89e25b8ad8c2de4ec0e973eac6403383705":1413496800000,"9266aac326b0b7e51215b62cf308ea4c6901001":1439416800000,"102667d89432eb749ecf9120beb4f273487836":1417042800000,"73a5c7e75cde8949ee1fe332045d6d23163887":1420671600000,"2ab604db214dc812ff0be58a75280d0c947725":1414101600000,"64b12bb6680832931cbfc486f859a1f69663531":1457827200000,"30b3f989f1c90d3a2275e0f2e0583eec6721372":1531699200000,"4e36b25d9559dae2bae20b5db69784306424581":1487980800000,"8cfd1e8d7ec40e8dee09bd96fd4827e74830841":1467072000000,"1d87d0a239c8e2f69181240098e0bb515984292":1539820800000,"5ffdfe87b7fab8b9506047effaeaefd03358521":1453507200000,"96e62e1385aa7bcfd1c0449d1a7fbcc81456031":1455667200000,"8504ea93820b40cbbfa1b387dd4ea2065914522":1508889600000,"f4cfae1741fd16ece88704684714d7df8856061":1474675200000,"929804497a6f920dbf77ae19f4856424088133":1436392800000,"3f4adfba53d1ae216fb40f9c51b72c843953371":1480982400000,"256eb8b8d98ba74ad948a5d35b177af26974131":1456099200000,"820ffc01d7a8d3c31ed3a484436d73d43094601":1443132000000,"ae4dcda11ac0f4cc7369e049d99e90652587002":1495324800000,"b37ff95bf3d129f615a50e1524d5c944273628":1423090800000,"62318a760610d302620d798354f373b55014371":1480982400000,"d9b370618bb0e8b83b5462b388bc07cc1793761":1477353600000,"202191e57559de496f6693c2dc2b6735603238":1423436400000,"fb5182f1392c2ff1b516e438eba536c8297457":1419548400000,"5748080bdc5c200a1a70f8f64fe93326401494":1413237600000,"45184b23e68d79b7b6e386e6517992db751608":1421276400000,"e249d101c8838712e66ad3a52def518e4404661":1476835200000,"cbc8c34da7247faa3498ddfdaedd0339386351":1359500400000,"fa772c81b1fd7eb1c696251b0d04f7a65399401":1442527200000,"2f4716c2bd9376edbca00dd4b6c146765167611":1447977600000,"b49f2172bad5fed7111d13de7c8dc2752937841":1467763200000,"ead53cf9dd9808aee051326b776081d2353088":1427752800000,"523c6faa5b5fd827851bfedfd4632009624885":1415574000000,"44b6efeda4b71a74e1c48917383447b39557701":1443736800000,"89fa2a86513755e6ab1e3aa2274f0ebc836425":1414015200000,"ff0208f05f1260a9798ba68f92e61e89002923":1403906400000,"1d2d89304a3bbb4c205b841516bda13d2128811":1448928000000,"44ad7dfb96cc638e0241eb3581e4f25e1022422":1508371200000,"7f5096b63a434548e6c951bf1595cf6a6593581":1487894400000,"3f3fa4e79c0e740b05db1c82525f69ab5945141":1461974400000,"70fcac25aa6aa2fbd8b6cc955482d89c773751":1385161200000,"c972aa0f3001ab6929afac0ca002cc478892801":1444082400000,"ab9cc414371923a2e8eaef7466f874f1913517":1418598000000,"8f853a3f296bd38820f1a5be5346a12e2596571":1482364800000,"95bf46b5909e3e8a493f7dfa4fa8f6569949611":1448064000000,"b7338b10f30c35e6b38c5a0726582c25698551":1379714400000,"df4e9a1fb8d928f54db1f30a63dcfa511466142":1515974400000,"d28f5ffd900460f7cf40be3e267bbf14570637":1419030000000,"a858cb9483b31957524b33a65ae29846981812":1390604400000,"cde990b866fca7ad04f31e05026c8aad2394641":1465689600000,"bde077d117c0ede5979bb22d63c7c4896776341":1463011200000,"78aed65d7d2b7b2c5d0a90bff0bb0e2d1810601":1443045600000,"c469a2457993bc5c56f8b620b0e1b28f881651":1393628400000,"27b0208dd52b30b4e2b882e64a5be4691113431":1457136000000,"7cdf17716a256caf6f64a8e20b77ef277300471":1481241600000,"413a4b407176a4fa687687f3416a3057540351":1352242800000,"aefa30db4c16e84ff341b4f289deffc9157846":1417302000000,"b18c7ff15bc643397cbcfdc3db5feebf208539":1433455200000,"687d536b4e342533566e83cd9b5a799d2084851":1474329600000,"cf0c6274092fd7336e4dcd878616d75b000028":1422918000000,"e635f00c5f8dd5526cd68182ae273b05171208":1421103600000,"2ad5cc4919ed368f16de4aecd570e21e477551":1379714400000,"118e7111871f4f5cc86c3c09720a27c51050841":1467072000000,"8e467959dea45302410c96ec10870825125758":1425078000000,"8d74fb89290200475c499368b3d98417606691":1385161200000,"bf22e1bbcc95d09ac399705242c143f8312828":1423177200000,"23e2139005ccedfe8e6b3c37bcf0cee75419451":1474243200000,"380b09e7bbf4180fc9f759776b8f097c443499":1438725600000,"7098764d8263ceaa1a9f12ef8764e16c6915221":1451520000000,"c700cee3702b36b2e1448c21570044685603721":1454284800000,"8789e9874c217032f3d31eee47ac235d7060931":1460505600000,"04d6badfff034762c87be88072d7d6840902252":1521590400000,"1460dfef05db61650e306a9dffbf801a267614":1411855200000,"66160541084b79f9483fe7e06210efa0035939":1433973600000,"969780420c2b65b0c1df25f867d7f4ac7465421":1452902400000,"c1158c0cb96d84a2704f77e75b71dbd13747031":1455753600000,"984972e051c5fd247b158f8c9ad85c5a417702":1409781600000,"5da7ddf9ff8ce80a5e64a121246932891267041":1461628800000,"4b1b2260c03436b5f602575ce46a4222159545":1414450800000,"95aa90c9e2d42490618bdcd450d4d7f01484031":1455580800000,"405aa1bdca37e8537535e9c33e372f5a0103921":1455062400000,"cf37a3447565ea342ce8df0b253ce420808691":1385161200000,"0834cfd00f523531e5cc29f59df6df673131612":1504569600000,"7aab30a932bb4dc09ebb9f1f957e6152429551":1379714400000,"33ab64bba7b3fbcd014b8bb7a50a4684569351":1364338800000,"8030c80f3b36a00cd362e8110e14da062378151":1471564800000,"39052a18adfadaf0d5433339689daf80513391":1385161200000,"a8b967f28d79915f0e9ee417e8a8ba87241003":1410818400000,"7dab58dfb936730addc18a19c8bf90dc8251311":1446422400000,"f1b039838b3ecdd0a39c67967cdcaa319301391":1491523200000,"b1ecc3118450e77dcecd270aa1b06ed19389571":1482624000000,"28454a86151bce48c23ac22fb376f3e14398321":1452556800000,"e7d29634cf05f264318da442156eef4a3765321":1452297600000,"0bea6253b3749971f42264b5a9f61c47439016":1416178800000,"451c7d6c43b913d0632e6b7bf68572d9750351":1352242800000,"5b50be7a419190cca124ca6b49a05787511622":1393628400000,"c6e5ad7553815b1e363a760b54acd01c0567431":1457395200000,"da6adbba2024ebd477e50ead9a07213e3258431":1457481600000,"6d219f068ab764fdb04fb06ad3239e035276141":1462060800000,"586112696d44f3ca397ae40e5f753a936357571":1482364800000,"8ff04b09372bb81a28efa47db309eb754607861":1478304000000,"20c33f4702f539763c0fcb7cf0637412919102":1393023600000,"ca514d3dbed6f63c3e8d1dd7f8616700477351":1364338800000,"ec83e7409ddc6ef9ac573d4bcc22aca38561761":1477267200000,"2af0331f8cc571c179f93f3db8b8ecd25292201":1441058400000,"9f9436415b31546fd172ce80584f7911852462":1395442800000,"283ba1e00a900473d2c55ea7cc98aad17165481":1487635200000,"fc6afa8a1a62d0f09def7223a0034f4b872414":1411768800000,"d4681678cee705783e248abc65a1baf8939551":1379714400000,"8a5ae5ffcfdf0d258abb4feefd0bb97b932828":1423177200000,"4668ea86c9c78fb6bee992a40504691b3435711":1448409600000,"fc4f169c90bf5c40aad6c8ad40be7003884518":1422486000000,"a1905808caa2155f3be0765758f342d35643123":1551139200000,"3ad08c8fc74743e754b16dda099bdaec2153761":1477353600000,"3be3e485aead22861f1d1b2ddfb631221501481":1487462400000,"b6b3d2af46caf704ac2bf95c40920e9e4520031":1455408000000,"8a21b9230bb1b680bef2637bf23e83df1475581":1487980800000,"8a99508867581b9a8789610255f2b14f9461141":1461801600000,"6f19ab54fd761c7c30ff60631069c4827845761":1477440000000,"796ed19c638a4cbd9cf6526be9cf56542142211":1445817600000,"ccc826888e9895afc973e960e719a2df859378":1426806000000,"0d1cf8c2cb55ff23933e7c03d035eb7e7474821":1454716800000,"d3a63a1c9bc5f599d386a89a42d165c07488981":1490054400000,"e30e2eaed69f0747e8826dbf32015ea1229103":1410904800000,"76473b843a28709a9c9b295457f6b0009799011":1444946400000,"1e561fec8e3904f6a4c83b643f80ac71784537":1419030000000,"9a235fdaa5d03f224d2c9fa3504c23892601421":1452643200000,"59193d1a9a693f023c52be6fd03f8f843618941":1469059200000,"f4689ec124aff31975d760d7c0609e196728711":1448582400000,"d5066dc401aa6de559f5125316970ee24451841":1467244800000,"9b28d4c303c056691bda0338b41b4351151937":1419116400000,"0e8ee899905ac853cd5ef723427837569895841":1467676800000,"ee22a3a22d16d638aa7e4190bfeda486459866":1417820400000,"5b4f89ffbaad7f5a6ad256595da624679763911":1449187200000,"175b16ca1e86fd5aa0c6db079cf9a3f64384111":1445299200000,"9a64cbaa4dcd2b204e2ba5f0c70fe1767344461":1475884800000,"1ea483a2125d552d0bcceaa6ecaa33da578407":1418338800000,"187004ca57d13d2966fe8cc26efc3fec1176761":1477526400000,"f821fba41249c450445b3f26c92271d1606338":1423436400000,"da00da963f9c2494989e682ed4dcacfc8882751":1474329600000,"ecf3d501c6654120cbf6e77f9fdb2c275489221":1451952000000,"7dfceba434aed56bea027e0d5ab9c5533080261":1475020800000,"adda31132c9fce3a03c33e8ae2fa45ba869448":1424127600000,"9dbf631edeae92062518cdb65694614f149006":1415919600000,"788f27e471ef3b961960100e0362b9134063871":1484524800000,"d5fd981572108ffe82fa726733e999cb8799751":1474329600000,"626d471310992598d258fa4062e62c95213451":1369778400000,"578836375ca5d678516f74824d6e23d32777581":1488153600000,"1bb3f198061576d25313257356d8c7937703571":1482105600000,"e98995520c3d5dc29d9282236771249c8964111":1445299200000,"aded62be13940e5023597372894cb433883451":1364338800000,"bd6706892e49290fb119aa5ddae4238a318297":1420758000000,"5e1a02737308c0fdf5fbf42c2a0676039926171":1480118400000,"2c2823db77966653fc75420efc8bf69d4713171":1479945600000,"90b4e890be716cf57928ced31afd98e15991941":1468281600000,"a55b9ba02c55c16d097ee5ff010483976480532":1512172800000,"765be7b212614a1e89346a24de08dff6961458":1424732400000,"d1296058654cec8ec8bbcf6a331e13c36274491":1492128000000,"b0693ba99eb713e0a19c2a94290fc0f75924571":1482192000000}
).forEach(entry => {
	const publicHandle = entry[0];
	const joinDate = entry[1];
	joinDates.set(publicHandle, joinDate);
});

function fetchRankings() {
	startSpin();
	const xhr = new XMLHttpRequest();
	const reqURL = 'https://cors-anywhere.herokuapp.com/https://www.codingame.com/services/Leaderboards/getGlobalLeaderboard';
	xhr.open("POST", reqURL);
	xhr.responseType = "json";
	xhr.onreadystatechange = (e) => {
		if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
			const res = xhr.response;
			console.log(res);
			addJoinDates(0, res);
		}
	}
	xhr.send("[" + rankingPage + ",{'keyword':'','active':false,'column':'','filter':''},null,true,'global']");
}

function addJoinDates(player, leaderboard) {
	if (player === leaderboard.users.length) {
		console.log(JSON.stringify(mapToObject(joinDates)));
		updateRanking(leaderboard);
	} else {
		const publicHandle = leaderboard.users[player].codingamer.publicHandle;
		let joinDate = joinDates.get(publicHandle);
		if (joinDate) {
			leaderboard.users[player].joinDate = joinDate;
			addJoinDates(player + 1, leaderboard);
		} else {
			fetchJoinDate(player, publicHandle, leaderboard);
		}
	}
}

function mapToObject(map) {
	const out = Object.create(null)
	map.forEach((value, key) => {
		if (value instanceof Map) {
			out[key] = mapToObject(value)
		} else {
			out[key] = value
		}
	})
	return out
}

function fetchJoinDate(player, publicHandle, leaderboard) {
	const xhr = new XMLHttpRequest();
	const reqURL = 'https://cors-anywhere.herokuapp.com/https://www.codingame.com/services/CodinGamer/findCodingamePointsStatsByHandle';
	xhr.open("POST", reqURL);
	xhr.responseType = "json";
	xhr.onreadystatechange = (e) => {
		if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
			const res = xhr.response;
			console.log(res);
			const joinDate = res.codingamePointsRankingDto.rankHistorics.dates[0];
			joinDates.set(publicHandle, joinDate);
			leaderboard.users[player].joinDate = joinDate;
			addJoinDates(player + 1, leaderboard);
		}
	}
	xhr.send("['" + publicHandle + "']");
}

fetchRankings();
